{% extends 'panel/layout/layout.html' %}
{% load static i18n %}

{% block head %}
{% endblock %}

{% block body %}
    {#    {% if user|has_role:"admin_temp" %}#}
    {% include 'panel/inc/sidebar.html' %}
    {#    {% endif %}#}
    <!-- BEGIN: Content-->

    <div class="app-content content">
    <div class="content-overlay"></div>
    <div class="content-wrapper">
        <h1 class="text-center mb-3">{% trans 'Yangi Qabul Yaratish' %}</h1>
        <div class="row breadcrumbs-top">
            <div class="col-12">
                <div class="heading-elements">
                    <ul class="list-inline mb-0 main-list-heading">
                        <li class="main-searchh">

                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <form method="get" autocomplete="off">

        <div class="row mx-2">
            <div class="col-md-12">
                <div class="content-body ml-1">

                    <!-- table Transactions start -->
                    <input class="form-control mb-1" id="myInput" type="text"
                           placeholder="{% trans 'Mahallani qidirish ...' %}">

                    <section id="table-transactions">
                        <div class="card">
                            <!-- datatable start -->

                            <div class="table-responsive" style="max-height: 314px;">
                                <table id="table-extended-transactions" class="table mb-0">
                                    <thead>
                                    <tr>
                                        <th class="pl-1"><input id="select-all" class="form-check ajax-murojatchi"
                                                                type="checkbox"></th>
                                        <th class="text-left pl-0">{% trans 'Mahalla Nomi' %}</th>
                                    </tr>
                                    </thead>
                                    <tbody id="myTable">
                                    {% for mahalla in mahallalar %}
                                        <tr>
                                            <td class="pl-1"><input type="checkbox" class="ajax-murojatchi"
                                                                    name="{{ mahalla.title }}"></td>
                                            <td class="text-left pl-0">
                                                {{ mahalla.title|safe | truncatechars:"150" }}
                                            </td>

                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </section>
                    <!-- datatable ends -->

                    <!-- table Transactions end -->
                </div>
            </div>
        </div>
        <div class="row mx-2">
            <div class="col-md-6">
                <div class="content-body ml-1">
                    <!-- table Transactions start -->

                    <section id="table-transactions">
                        <div class="card">
                            <!-- datatable start -->
                            <div class="table-responsive" style="max-height: 314px;">
                                <table id="table-extended-transactions" class="table mb-0 ajax-muammo"
                                       data-url="{% url 'panel:murojatchi_filter' %}">
                                    <thead>
                                    <tr>
                                    <tr>
                                        <th class="pl-1">
                                            <input id="select-all-muammo" class="form-check muammo-filter"
                                                   type="checkbox"></th>
                                        <th class="text-left pl-0">{% trans 'Muammo ' %}</th>
                                    </tr>
                                    </thead>
                                    <tbody class="muammo-tbody">

                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </section>
                    <!-- datatable ends -->


                    <!-- table Transactions end -->
                </div>
            </div>
            <div class="col-md-6">
                <div class="content-body ml-1">
                    <!-- table Transactions start -->

                    <section id="table-transactions">
                        <div class="card">
                            <!-- datatable start -->
                            <div class="table-responsive" style="max-height: 314px;">
                                <table id="table-extended-transactions" class="table mb-0 category-contents"
                                       data-url="{% url 'panel:muammo_filter' %}">
                                    <thead>
                                    <tr>
                                        <th class="pl-1"><input id="select-all-category"
                                                                class="form-check category-checkbox"
                                                                type="checkbox"></th>
                                        <th class="text-center">{% trans 'Kategoriya' %}</th>
                                        <th class="text-left"></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </section>
                    <!-- datatable ends -->


                    <!-- table Transactions end -->
                </div>
            </div>
        </div>
    </form>



    <form method="POST" autocomplete="off">
        {% csrf_token %}

        <div class="row mx-2">
            <div class="col-md-12">
                <div class="content-body">
                    <!-- table Transactions start -->
                    <section id="table-transactions" style="margin-left:17px;">
                        <div class="card">
                            <!-- datatable start -->
                            <div class="table-responsive" style="max-height: 380px;">
                                <table id="table-extended-transactions" class="table mb-0 murojatchi-contents">
                                    <thead>
                                    <tr>
                                        <th class="pr-2"><input id="select-all-murojatchi" type="checkbox"
                                                                class="murojatchi-checkbox"></th>
                                        <th class="pl-0">{% trans 'Murojatchi' %}</th>
                                        <th class="text-left">{% trans 'Telefon' %}</th>
                                        <th class="text-left">{% trans 'Murojat Sanasi' %}</th>

                                    </tr>
                                    </thead>
                                    <tbody class="murojatchi-list">

                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- datatable ends -->
                    </section>
                </div>
            </div>
        </div>
        <div class="row mx-2">
            <div class="col-md-12">
                <div class="tab-content main-editor mx-1">
                    <div class="tab-pane active" id="uzbek" role="tabpanel"
                         aria-labelledby="home-tab"
                         aria-expanded="false">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title" style="text-transform: inherit;">
                                    {% trans "Qabul Nomi" %}</h4>
                            </div>
                            <div class="card-content">
                                <div class="card-body pb-0">
                                    <div class="row invoice-info">
                                        <div class="col-lg-12 col-md-12">
                                            <fieldset class="invoice-address form-group">
                                                <input type="text" required maxlength="256"
                                                       class="form-control"
                                                       v-model="title_uz"
                                                       name="title"
                                                       placeholder="{% trans 'Qabul nomini kirirting' %}">
                                            </fieldset>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mx-2">
            <div class="col-md-3 ml-1">
                <input type="date" name="appointment" required class="form-control">
            </div>
            <div class="col-md-9"></div>
        </div>
        <div class="row mx-2">
            <button class="btn btn-info ml-2 mt-2" id="checkBtn" type="submit">{% trans 'Yaratish' %}</button>
        </div>
    </form>


{% endblock %}
</div>

{% block js %}
    <script>
        $('#select-all').click(function (e) {
            var table = $(e.target).closest('table');
            $('td input:checkbox', table).prop('checked', this.checked);
        });

        $('#select-all-muammo').click(function (e) {
            var table = $(e.target).closest('table');
            $('td input:checkbox', table).prop('checked', this.checked);
        });
        $('#select-all-category').click(function (e) {
            var table = $(e.target).closest('table');
            $('td input:checkbox', table).prop('checked', this.checked);
        });
        $('#select-all-murojatchi').click(function (e) {
            var table = $(e.target).closest('table');
            $('td input:checkbox', table).prop('checked', this.checked);
        });


    </script>

    <script>
        $(document).ready(function (e) {
            $('.ajax-murojatchi').click(function () {
                let choices = {}

                $('.murojatchi-list').empty();
                $('.muammo-tbody').empty();

                $('input[type=checkbox]:checked').each(function () {

                    choices[this.name] = this.value
                });

                $.ajax({
                    type: 'GET',
                    url: "{% url 'panel:ajax_mahalla' %}",

                    dataType: 'json',
                    cache: false,
                    data: {
                        choices: choices,
                    },

                    success: function (data) {

                        $('.murojatchi-contents').find('tbody').empty()
                        $('.ajax-muammo').find('tbody').empty()
                        let json_data = JSON.parse(data.query)
                        let list_problem = []

                        json_data.forEach(function (d) {

                            if (!list_problem.includes(d.fields.muammo)) {
                                list_problem.push(d.fields.muammo)
                                $('.ajax-muammo').find('tbody').append('<tr>' +
                                    '<td class="pl-1"><input class="form-check muammo-filter"  type="checkbox" name="' + d.fields.muammo + '">' +
                                    '</td>' +
                                    '<td class="text-left pl-0 py-1">' +
                                    '<ul class="list-unstyled list-inline">' +
                                    '<li class="list-inline-item">' + d.fields.muammo + '</li>' +
                                    '</ul></td></tr>')

                            }

                        })

                        json_data.forEach(function (d) {
                            $('.murojatchi-contents').find('tbody').append('<tr>' +
                                '<td><input type="checkbox" class="murojatchi-checkbox" name="users" value="' + d.pk + '"></td>' +
                                '<td class="text-left">' + d.fields.fullname + '</td>' +
                                '<td class="text-left">' + d.fields.phone + '</td>' +
                                '<td class="text-left">' + d.fields.created + '</td>' +
                                '</tr>')
                        })

                    },
                    error: function (err) {
                        console.log(err);
                        console.log(choices);
                    }
                });
            })

            $('body').on('click', '.muammo-filter', function () {

                let choices = {}

                $('.category-list').empty();
                $('.murojatchi-list').empty();

                $('input[type=checkbox]:checked').each(function () {
                    choices[this.name] = this.value
                });

                $.ajax({
                    type: 'GET',
                    url: "{% url 'panel:muammo_filter' %}",

                    dataType: 'json',
                    cache: false,
                    data: {
                        choices: choices,
                        // problems: problems,
                    },


                    success: function (data) {
                        $('.category-contents').find('tbody').empty()
                        $('.murojatchi-contents').find('tbody').empty()

                        console.log(data)

                        Object.entries(data.query).forEach((entry) => {
                            const [key, value] = entry;

                            $('.category-contents').find('tbody').append(' <tr class = "kategory_list"><td class="pl-1"><input type="checkbox" name="' + key + '" class ="category-checkbox"></td>' +
                                '<td class="text-center ajax-category" >' +
                                key +
                                '</td>' +
                                '</tr>');
                        });

                        JSON.parse(data.users).forEach(function (d) {
                            console.log(data.users)
                            $('.murojatchi-contents').find('tbody').append('<tr>' +
                                '<td><input type="checkbox" class="murojatchi-checkbox" name="users" value="' + d.pk + '"></td>' +
                                '<td class="text-left">' + d.fields.fullname + '</td>' +
                                '<td class="text-left">' + d.fields.phone + '</td>' +
                                '<td class="text-left">' + d.fields.created + '</td>' +
                                '</tr>')
                        })

                    },
                    error: function (err) {
                        console.log(err);
                        console.log(choices);
                    }
                });


            })

            $('body').on('click', '.category-checkbox', function () {
                let choices = {}


                $('input[type=checkbox]:checked').each(function () {
                    choices[this.name] = this.value
                });

                $.ajax({
                    type: 'GET',
                    url: "{% url 'panel:ajax_filter_category' %}",

                    dataType: 'json',
                    cache: false,
                    data: {
                        choices: choices,

                    },


                    success: function (data) {
                        $('.murojatchi-contents').find('tbody').empty()

                        JSON.parse(data.query).forEach(function (d) {
                            $('.murojatchi-contents').find('tbody').append('<tr>' +
                                '<td><input type="checkbox" class="murojatchi-checkbox" name="users"  value="' + d.pk + '"></td>' +
                                '<td class="text-left">' + d.fields.fullname + '</td>' +
                                '<td class="text-left">' + d.fields.phone + '</td>' +
                                '<td class="text-left">' + d.fields.created + '</td>' +
                                '</tr>')
                        })

                    },
                    error: function (err) {
                        console.log(err);
                        console.log(choices);
                    }
                });

            })

        });
    </script>

    <script>
        $(document).ready(function (e) {
            $('body').on('click', '.murojatchi-checkbox', function () {
                let choices = []

                $('.murojatchi-checkbox:input[type=checkbox]:checked').each(function () {

                    choices.push(this.value)
                });


            })
        });
    </script>

    <script>
        $(document).ready(function () {
            $("#myInput").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $("#myTable tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });
    </script>

    <script>
    $('form').submit(function(e) {
        if ($('[name="users"]:checked').length === 0) {
            e.preventDefault()
            alert('Murojatchilarni tanlang')
        }
    });
    </script>




{% endblock %}

